<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Movies Aro — Play Online</title>
<style>
:root{
  --bg:#0d1117;--card:rgba(255,255,255,0.06);
  --accent:#00c6ff;--accent2:#0072ff;--text:#e6edf3;--muted:#8b949e;
  --error:#ff6b6b;
}
html,body{height:100%;background:linear-gradient(135deg,#0d1117,#161b22);color:var(--text);margin:0;font-family:Inter,Segoe UI,sans-serif;}
.wrap{max-width:980px;margin:18px auto;padding:0 16px;}
h1{ text-align:center;font-size:2.0rem;margin-bottom:18px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.controls{display:flex;gap:10px;margin-bottom:12px;}
input[type="text"]{flex:1;padding:10px 12px;border-radius:8px;border:none;background:var(--card);color:var(--text);outline:none}
button{padding:10px 14px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;cursor:pointer;font-weight:700}
.hint{color:var(--muted);font-size:0.95rem;margin-bottom:10px}
.result{background:var(--card);border-radius:10px;padding:14px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 6px 20px rgba(0,0,0,0.4)}
.meta{font-size:0.95rem;white-space:pre-wrap;color:var(--text);margin-bottom:10px}
.links{margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
.play-btn{display:inline-block;margin:6px 8px 6px 0;padding:8px 12px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent);cursor:pointer}
.play-btn:hover{border-color:var(--accent2);color:var(--accent2)}
.error{color:var(--error);font-weight:700}
.loading{color:var(--muted)}

/* YouTube-style overlay player */
#video-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.92);z-index:99999}
.yt-player{width:90%;max-width:1100px;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden;position:relative;box-shadow:0 8px 40px rgba(0,0,0,0.7)}
.yt-player .top-bar{position:absolute;left:0;right:0;top:0;height:44px;padding:8px 12px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg, rgba(0,0,0,0.25), transparent);color:#fff;z-index:2}
.yt-player .title{font-weight:600; font-size:14px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.close-btn{background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer}
.yt-player video{width:100%;height:100%;background:#000;display:block}
.small-note{color:var(--muted);font-size:0.85rem;margin-top:8px;text-align:center}

/* Mobile tweaks */
@media (max-width:640px){
  .controls{flex-direction:column}
  button{width:100%}
  .yt-player{width:98%}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>Movies Aro</h1>

  <div class="controls">
    <input id="q" type="text" placeholder="Type file name..." />
    <button id="searchBtn">Search</button>
  </div>

  <div class="hint">⌛ Please wait.. <span id="count">10</span> seconds then search</div>

  <div class="button-box" style="text-align:center;margin:18px 0;">
    <button onclick="window.open('https://moviesaro.netlify.app', '_self')">Go to Movies Aro (OLD)</button>
    <button onclick="window.open('https://moviesarodub.netlify.app', '_self')">All Tamil Dubbed Movies</button>
  </div>

  <div id="output"></div>
  <div id="debug" style="margin-top:14px;color:var(--muted);font-size:0.9rem"></div>
</div>

<script>
/*
  IMPORTANT:
  - If your .txt files are in the same folder as this HTML on GitHub Pages -> leave GITHUB_RAW_BASE = ''.
  - If your .txt files are located elsewhere on GitHub, set GITHUB_RAW_BASE to the raw URL prefix, e.g:
    "https://raw.githubusercontent.com/USERNAME/REPO/main/path/to/txts/"
*/
const GITHUB_RAW_BASE = ''; // <-- set this if needed

const yearlyFiles = [
  "1920.txt","1945.txt","1947.txt","1950.txt","1993.txt","1995.txt","1996.txt","1999.txt",
  "2003.txt","2005.txt","2007.txt","2008.txt","2009.txt","2010.txt","2012.txt","2013.txt",
  "2014.txt","2015.txt","2016.txt","2017.txt","2018.txt","2019.txt","2020.txt","2021.txt",
  "2022.txt","2023.txt","2024.txt","2025.txt","Unknown_Year.txt"
];

let files = [];

function debugLog(msg){ const dbg=document.getElementById('debug'); dbg.textContent = msg; console.log('[debug]', msg); }

// try a list of candidate URLs to fetch a file
async function tryFetchFile(fname){
  const candidates = [];
  // relative first
  candidates.push(fname);
  candidates.push('./' + fname);
  // user-specified raw base
  if(GITHUB_RAW_BASE && GITHUB_RAW_BASE.trim()){
    const base = GITHUB_RAW_BASE.trim();
    candidates.push(base + fname);
  }
  // If hosted on github pages, attempt to derive raw.githubusercontent.com paths
  try{
    if(location.hostname.endsWith('github.io')){
      const username = location.hostname.split('.')[0];
      const parts = location.pathname.split('/').filter(Boolean);
      const repoCandidate = parts[0] || (username + '.github.io');
      ['main','master'].forEach(br=>{
        candidates.push(`https://raw.githubusercontent.com/${username}/${repoCandidate}/${br}/${fname}`);
        candidates.push(`https://raw.githubusercontent.com/${username}/${username}.github.io/${br}/${fname}`);
      });
    }
  }catch(e){ /* ignore */ }

  for(const url of candidates){
    try{
      // small timeout helper
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), 8000);
      const resp = await fetch(url, {signal: controller.signal});
      clearTimeout(id);
      if(resp && resp.ok){
        const text = await resp.text();
        if(text && text.trim().length > 10){
          console.info('Loaded', fname, 'from', url);
          return { text, sourceUrl: url };
        }
      }
    }catch(err){
      // ignore; try next
      // console.warn('Failed', url, err);
    }
  }
  return null;
}

async function loadAllFiles(){
  files = [];
  debugLog('Loading index files...');
  for(const f of yearlyFiles){
    try{
      const result = await tryFetchFile(f);
      if(!result){
        console.warn('Could not load', f);
        continue;
      }
      const data = result.text;
      // split by --- blocks (existing format)
      const rawBlocks = data.split('---').map(b=>b.trim()).filter(Boolean);
      const parsed = rawBlocks.map(block=>{
        const nameM = block.match(/File Name:\s*(.*)/i);
        const sizeM = block.match(/File Size:\s*(.*)/i);
        const linkM = block.match(/Download Link:\s*(.*)/i);
        return {
          name: nameM ? nameM[1].trim() : '',
          size: sizeM ? sizeM[1].trim() : '',
          link: linkM ? linkM[1].trim() : '',
          srcFile: result.sourceUrl
        };
      }).filter(f=>f.name && f.link);
      files = files.concat(parsed);
    }catch(e){
      console.error('loadAllFiles error', e);
    }
  }
  debugLog(`Loaded ${files.length} records from index files.`);
  if(files.length === 0){
    document.getElementById('output').innerHTML = '<div class="error">No index entries loaded. Make sure your .txt files are reachable. If they are on GitHub, set the GITHUB_RAW_BASE variable near the top of this script to your raw URL prefix (see comments).</div>';
  }
}

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function renderResults(list){
  const outEl = document.getElementById('output');
  outEl.innerHTML = '';
  if(!list.length){
    outEl.innerHTML = '<div class="error">No results found.</div>';
    return;
  }
  list.forEach((f,idx)=>{
    const container = document.createElement('div');
    container.className = 'result';
    container.innerHTML = `
      <div class="meta">File Name: ${escapeHtml(f.name)}\nFile Size: ${escapeHtml(f.size)}</div>
      <div style="margin-top:8px;"><button data-link="${escapeHtml(f.link)}" class="play-main-btn">Play Online</button></div>
      <div class="links" id="links-${idx}" aria-live="polite"></div>
    `;
    outEl.appendChild(container);

    const playBtn = container.querySelector('.play-main-btn');
    const linksContainer = container.querySelector(`#links-${idx}`);

    playBtn.addEventListener('click', async ()=>{
      playBtn.disabled = true;
      const originalText = playBtn.textContent;
      playBtn.textContent = 'Fetching streams...';
      linksContainer.innerHTML = '';
      try{
        await fetchAndShowStreamButtons(playBtn.dataset.link, linksContainer);
      }catch(err){
        linksContainer.innerHTML = `<div class="error">Error: ${escapeHtml(err.message || String(err))}</div>`;
      }finally{
        playBtn.disabled = false;
        playBtn.textContent = originalText;
      }
    });
  });
}

// Fetches the remote page (via a proxy to avoid CORS for arbitrary pages), extracts link(s), and shows Play Online 1/2 buttons
async function fetchAndShowStreamButtons(targetUrl, containerEl){
  containerEl.innerHTML = '<div class="loading">Fetching available streams...</div>';

  let anchors = [];

  // Case 1: if targetUrl already looks like a video file → use directly
  if(/\.(mp4|m3u8|webm)(\?|$)/i.test(targetUrl)){
    anchors = [targetUrl];
  } else {
    // Case 2: fetch only once with fast proxy
    try {
      const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(targetUrl);
      const resp = await fetch(proxyUrl);
      const text = await resp.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');

      let downloadDiv = doc.querySelector('.download');
      if(downloadDiv){
        anchors = Array.from(downloadDiv.querySelectorAll('a'))
          .map(a => new URL(a.getAttribute('href') || a.href, targetUrl).href);
      }

      if(anchors.length === 0){
        const regex = /https?:\/\/[^\s"']+\.(mp4|m3u8|webm)/gi;
        anchors = [...text.matchAll(regex)].map(m => m[0]);
      }
    } catch(err){
      containerEl.innerHTML = '<div class="error">Failed to load links.</div>';
      return;
    }
  }

  // Deduplicate
  anchors = Array.from(new Set(anchors));

  if(anchors.length === 0){
    containerEl.innerHTML = '<div class="error">No playable links found.</div>';
    return;
  }

  // Show Play Online 1,2,3...
  containerEl.innerHTML = '';
  anchors.forEach((link, i) => {
    const btn = document.createElement('button');
    btn.className = 'play-btn';
    btn.textContent = `Play Online ${i+1}`;
    btn.onclick = () => playVideoOverlay(link, { title: `Play Online ${i+1}` });
    containerEl.appendChild(btn);
  });
}

  // small note for the user
  const note = document.createElement('div');
  note.className = 'small-note';
  note.textContent = 'If the player cannot play a stream because of server CORS/settings, the link will open in a new tab as a fallback.';
  containerEl.appendChild(note);
}

// Creates a YouTube-style, dark overlay player and plays the given video URL
function playVideoOverlay(url, opts = {}){
  // remove existing overlay if any
  const existing = document.getElementById('video-overlay');
  if(existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'video-overlay';

  const playerWrap = document.createElement('div');
  playerWrap.className = 'yt-player';

  // Topbar with title + close
  const topBar = document.createElement('div');
  topBar.className = 'top-bar';
  const title = document.createElement('div');
  title.className = 'title';
  title.textContent = opts.title || url;
  const closeBtn = document.createElement('button');
  closeBtn.className = 'close-btn';
  closeBtn.innerHTML = '&#10005;';
  closeBtn.title = 'Close (Esc)';

  topBar.appendChild(title);
  topBar.appendChild(closeBtn);

  const videoEl = document.createElement('video');
  videoEl.setAttribute('playsinline', '');
  videoEl.setAttribute('controls', '');
  videoEl.setAttribute('autoplay', '');
  videoEl.setAttribute('preload', 'metadata');
  videoEl.setAttribute('controlsList', 'nodownload');
  videoEl.setAttribute('crossorigin', 'anonymous'); // may help with some CORS setups
  videoEl.addEventListener('contextmenu', e => e.preventDefault());

  // MP4 source
  const source = document.createElement('source');
  source.src = url;
  // try to detect type from URL
  if(url.match(/\.m3u8(\?|$)/i)) source.type = 'application/vnd.apple.mpegurl';
  else if(url.match(/\.webm(\?|$)/i)) source.type = 'video/webm';
  else source.type = 'video/mp4';
  videoEl.appendChild(source);

  // Error handling: fallback to opening a new tab
  let errorHandled = false;
  videoEl.addEventListener('error', (ev) => {
    if(errorHandled) return;
    errorHandled = true;
    console.warn('Video error, opening in new tab as fallback:', url, ev);
    try{
      window.open(url, '_blank');
      // show a small message then close overlay
      const msg = document.createElement('div');
      msg.className = 'small-note';
      msg.textContent = 'Could not play inside the page — opened the stream in a new tab.';
      playerWrap.appendChild(msg);
      setTimeout(()=>{ overlay.remove(); }, 2000);
    }catch(e){
      overlay.remove();
    }
  });

  // append elements
  playerWrap.appendChild(topBar);
  playerWrap.appendChild(videoEl);
  overlay.appendChild(playerWrap);
  document.body.appendChild(overlay);

  // close handlers
  closeBtn.addEventListener('click', ()=> overlay.remove());
  overlay.addEventListener('click', (ev)=> {
    if(ev.target === overlay) overlay.remove(); // click outside closes
  });
  document.addEventListener('keydown', function escHandler(e){
    if(e.key === 'Escape'){ overlay.remove(); document.removeEventListener('keydown', escHandler); }
  });

  // try to play (browsers may block autoplay with sound, so we try and ignore failures)
  const playPromise = videoEl.play();
  if(playPromise && typeof playPromise.then === 'function'){
    playPromise.catch(err => {
      // some browsers block autoplay with sound; mute then play
      try{
        videoEl.muted = true;
        videoEl.play().catch(()=>{});
      }catch(e){ /* ignore */ }
    });
  }
}

// Search wiring
const qEl = document.getElementById('q');
const searchBtn = document.getElementById('searchBtn');

function doSearch(){
  const q = qEl.value.trim();
  if(!q){ document.getElementById('output').innerHTML = '<div class="hint">Type a search term.</div>'; return; }
  const filtered = files.filter(f => f.name.toLowerCase().includes(q.toLowerCase()));
  renderResults(filtered);
}

searchBtn.addEventListener('click', doSearch);
qEl.addEventListener('keydown', e => { if(e.key === 'Enter') doSearch(); });

/* initial countdown + load */
let t = 10, el = document.getElementById('count');
const interval = setInterval(()=>{ el.textContent = --t; if(t<=0) clearInterval(interval); }, 1000);

(async function init(){
  await loadAllFiles();
  // Optional: auto-search if q param present
  const params = new URLSearchParams(location.search);
  const q = params.get('q');
  if(q){ qEl.value = q; doSearch(); }
})();
</script>
</body>
</html>
